name: Update File (Dynamic Key)

on:
  # Trigger the workflow manually from GitHub UI
  workflow_dispatch:
    inputs:
      file_path:
        description: 'Path to file in repository (e.g., scripts/main.js)'
        required: true
        type: string
      content_type:
        description: 'File content type (e.g., text/javascript, text/css)'
        required: false
        default: 'text/plain'
        type: string

jobs:
  update-file:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Get file key and update file
        env:
          API_BASE_URL: https://sheffielddev.resources.ukpreview.empro.verintcloudservices.com
          API_USERNAME: ${{ secrets.VERINT_USERNAME }}
          API_PASSWORD: ${{ secrets.secrets.VERINT_PASSWORD }}
          FILE_PATH: ${{ github.event.inputs.file_path }}
          CONTENT_TYPE: ${{ github.event.inputs.content_type }}
        run: |
          # 1. Separate filename and folder from the input path
          FULL_PATH="${FILE_PATH}"
          FOLDER_NAME=$(dirname "$FULL_PATH")
          FILENAME=$(basename "$FULL_PATH")
          
          echo "Looking for file: '$FILENAME' in folder: '$FOLDER_NAME'"

          # 2. Call the GET /files API to find the file key
          response_get=$(curl -s -u "${API_USERNAME}:${API_PASSWORD}" \
            "${API_BASE_URL}/files?query=${FILENAME}")

          FILE_KEY=""
          
          # Use jq to find the key for the file matching both the name and folder
          # jq is pre-installed on GitHub-hosted runners
          if echo "$response_get" | jq -e .collection > /dev/null; then
            FILE_KEY=$(echo "$response_get" | jq -r --arg filename "$FILENAME" --arg foldername "$FOLDER_NAME" '.collection[] | select(.fileName == $filename and .folderName == $foldername) | .key')
          fi

          if [ -z "$FILE_KEY" ]; then
            echo "âŒ File not found on the server or multiple matches found that didn't match the folder."
            echo "Response: $response_get"
            exit 1
          fi

          echo "âœ… Found file key: $FILE_KEY"
          
          # 3. Use the retrieved key to perform the PUT request (update)
          echo "ğŸ”„ Starting file update with key: $FILE_KEY"
          
          response_put=$(curl -s -w "HTTPSTATUS:%{http_code}" \
            -X 'PUT' \
            "${API_BASE_URL}/files/${FILE_KEY}" \
            -H 'accept: application/json' \
            -u "${API_USERNAME}:${API_PASSWORD}" \
            -H 'Content-Type: multipart/form-data' \
            -F "file=@${FILE_PATH};type=${CONTENT_TYPE}")

          # Extract and check HTTP status code for the PUT request
          http_code=$(echo $response_put | tr -d '\n' | sed -e 's/.*HTTPSTATUS://')
          body_put=$(echo $response_put | sed -E 's/HTTPSTATUS\:[0-9]{3}$//')
          
          echo "================== UPDATE RESULT =================="
          echo "HTTP Status Code: $http_code"
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 204 ]; then
            echo "âœ… File update successful!"
            echo "$body_put" > update_response.json
          else
            echo "âŒ File update failed!"
            echo "ğŸ“„ Response: $body_put"
            exit 1
          fi
          echo "================================================="

      - name: Upload response as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: update-response-${{ github.run_number }}
          path: update_response.json
          retention-days: 7
